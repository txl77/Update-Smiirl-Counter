name: Track Twitter Followers (Scraping Alternative)

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  track-followers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 selenium webdriver-manager

      - name: Get followers count via scraping
        env:
          NPOINT_API_TOKEN: ${{ secrets.NPOINT_API_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import os
          from datetime import datetime
          import json
          import re
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from webdriver_manager.chrome import ChromeDriverManager

          twitter_username = "UEFrance"
          npoint_url = "https://api.npoint.io/5c1ef38596efbfb2bfe9"
          
          # Configuration Chrome headless
          chrome_options = Options()
          chrome_options.add_argument('--headless')
          chrome_options.add_argument('--no-sandbox')
          chrome_options.add_argument('--disable-dev-shm-usage')
          chrome_options.add_argument('--disable-gpu')
          chrome_options.add_argument('--window-size=1920,1080')
          chrome_options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')
          
          try:
              print(f"ðŸ” RÃ©cupÃ©ration des donnÃ©es pour @{twitter_username}...")
              
              # Initialiser le driver
              service = Service(ChromeDriverManager().install())
              driver = webdriver.Chrome(service=service, options=chrome_options)
              
              # Charger la page
              url = f"https://x.com/{twitter_username}"
              driver.get(url)
              
              # Attendre que la page charge
              wait = WebDriverWait(driver, 15)
              
              # Attendre l'Ã©lÃ©ment contenant le nombre de followers
              # X.com affiche gÃ©nÃ©ralement le nombre de followers dans un Ã©lÃ©ment avec du texte "Followers"
              try:
                  # Chercher dans le code source
                  page_source = driver.page_source
                  
                  # MÃ©thode 1: Regex pour trouver followers_count dans le JSON embarquÃ©
                  pattern = r'"followers_count":(\d+)'
                  match = re.search(pattern, page_source)
                  
                  if match:
                      followers_count = int(match.group(1))
                      print(f"âœ… Nombre de followers trouvÃ©: {followers_count}")
                  else:
                      # MÃ©thode 2: Chercher le texte visible "Followers"
                      followers_elements = driver.find_elements(By.XPATH, "//*[contains(text(), 'Followers') or contains(text(), 'AbonnÃ©s')]")
                      
                      for elem in followers_elements:
                          text = elem.text
                          # Extraire le nombre (format: "1,234 Followers" ou "1.2K Followers")
                          number_match = re.search(r'([\d,\.]+[KMB]?)\s*(?:Followers|AbonnÃ©s)', text)
                          if number_match:
                              followers_str = number_match.group(1)
                              # Convertir K, M, B en nombres
                              if 'K' in followers_str:
                                  followers_count = int(float(followers_str.replace('K', '').replace(',', '')) * 1000)
                              elif 'M' in followers_str:
                                  followers_count = int(float(followers_str.replace('M', '').replace(',', '')) * 1000000)
                              elif 'B' in followers_str:
                                  followers_count = int(float(followers_str.replace('B', '').replace(',', '')) * 1000000000)
                              else:
                                  followers_count = int(followers_str.replace(',', '').replace('.', ''))
                              print(f"âœ… Nombre de followers trouvÃ© (mÃ©thode visible): {followers_count}")
                              break
                      else:
                          print("âŒ Impossible de trouver le nombre de followers")
                          driver.quit()
                          exit(1)
                  
                  # Envoyer Ã  npoint.io
                  payload = {
                      "username": twitter_username,
                      "followers_count": followers_count,
                      "last_updated": datetime.utcnow().isoformat(),
                      "timestamp": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC"),
                      "method": "scraping"
                  }
                  
                  npoint_headers = {
                      "Content-Type": "application/json"
                  }
                  
                  npoint_token = os.environ.get('NPOINT_API_TOKEN')
                  if npoint_token:
                      npoint_headers["X-API-Token"] = npoint_token
                  
                  npoint_response = requests.post(
                      npoint_url,
                      headers=npoint_headers,
                      json=payload
                  )
                  
                  if npoint_response.status_code in [200, 201]:
                      print(f"âœ… DonnÃ©es envoyÃ©es Ã  npoint.io avec succÃ¨s")
                      print(f"ðŸ“Š DonnÃ©es: {json.dumps(payload, indent=2)}")
                  else:
                      print(f"âš ï¸  Erreur lors de l'envoi Ã  npoint.io: {npoint_response.status_code}")
                      print(f"Response: {npoint_response.text}")
                      
              except Exception as e:
                  print(f"âŒ Erreur lors de la recherche des followers: {e}")
                  driver.quit()
                  exit(1)
              
              driver.quit()
              
          except Exception as e:
              print(f"âŒ Erreur gÃ©nÃ©rale: {e}")
              exit(1)
          
          EOF
