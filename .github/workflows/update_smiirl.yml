name: Update Instagram Followers

on:
  schedule:
    - cron: '0 * * * *' # toutes les heures
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Instagram followers and update npoint
        shell: bash
        run: |
          NPOINT_URL="https://api.npoint.io/5c1ef38596efbfb2bfe9"

echo "Fetching followers for @uefrance"

FETCH_HTML() {
  curl -s \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
    -H "Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7" \
    -H "Accept: text/html" \
    -H "Referer: https://www.instagram.com/" \
    --compressed \
    "https://www.instagram.com/uefrance/"
}

# 1️⃣ HTML scraping direct (le plus fiable sur GitHub)
HTML=$(FETCH_HTML)

FOLLOWERS=$(echo "$HTML" | grep -oP '"edge_followed_by":\{"count":\K[0-9]+')

# 2️⃣ Vérification
if [ -z "$FOLLOWERS" ]; then
  echo "❌ Failed to fetch followers"
  echo "---- DEBUG (first 500 chars) ----"
  echo "$HTML" | head -c 500
  exit 1
fi

echo "Followers: $FOLLOWERS"

# 3️⃣ Update npoint
curl -s -X POST "$NPOINT_URL" \
  -H "Content-Type: application/json" \
  -d "{\"number\": $FOLLOWERS}"

echo "✅ npoint updated successfully"
