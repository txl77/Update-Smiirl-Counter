name: Update Twitter Followers via Nitter

on:
  schedule:
    # Ex√©cute tous les jours √† 9h00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Permet l'ex√©cution manuelle

jobs:
  update-followers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Get followers from Nitter and update npoint
        run: |
          python << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import json
          import re

          # Configuration
          twitter_username = "UEFrance"
          npoint_url = "https://api.npoint.io/5c1ef38596efbfb2bfe9"
          
          # Liste des instances Nitter √† essayer
          nitter_instances = [
              "https://nitter.net",
              "https://nitter.poast.org",
              "https://nitter.privacydev.net",
              "https://nitter.eu",
              "https://nitter.it",
              "https://nitter.cz",
              "https://nitter.fdn.fr",
              "https://nitter.1d4.us",
          ]
          
          followers_count = None
          instance_used = None
          
          print(f"üîç Recherche des followers pour @{twitter_username}...")
          print("")
          
          # Essayer chaque instance Nitter
          for instance in nitter_instances:
              try:
                  url = f"{instance}/{twitter_username}"
                  print(f"üåê Tentative: {url}")
                  
                  headers = {
                      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                  }
                  
                  response = requests.get(url, headers=headers, timeout=10)
                  
                  if response.status_code == 200:
                      soup = BeautifulSoup(response.content, 'html.parser')
                      
                      # Chercher l'√©l√©ment <li class="followers">
                      followers_li = soup.find('li', class_='followers')
                      
                      if followers_li:
                          # Chercher le <span class="profile-stat-num"> √† l'int√©rieur
                          stat_num = followers_li.find('span', class_='profile-stat-num')
                          
                          if stat_num:
                              # R√©cup√©rer le texte et nettoyer (enlever les virgules)
                              followers_text = stat_num.text.strip()
                              followers_count = int(followers_text.replace(',', '').replace(' ', ''))
                              instance_used = instance
                              
                              print(f"‚úÖ Trouv√©: {followers_count:,} followers")
                              print(f"üìç Source: {instance}")
                              break
                      else:
                          print(f"   ‚ö†Ô∏è  Structure HTML non trouv√©e")
                  else:
                      print(f"   ‚ö†Ô∏è  Erreur HTTP {response.status_code}")
                      
              except requests.exceptions.Timeout:
                  print(f"   ‚è±Ô∏è  Timeout")
              except requests.exceptions.RequestException as e:
                  print(f"   ‚ùå Erreur: {str(e)[:50]}")
              except Exception as e:
                  print(f"   ‚ùå Erreur inattendue: {str(e)[:50]}")
          
          print("")
          
          # V√©rifier si on a trouv√© le nombre de followers
          if followers_count is None:
              print("‚ùå Impossible de r√©cup√©rer le nombre de followers depuis toutes les instances Nitter")
              print("")
              print("üí° Suggestions:")
              print("   - V√©rifiez que les instances Nitter sont accessibles")
              print("   - R√©essayez plus tard")
              print("   - Utilisez l'API Twitter officielle pour plus de fiabilit√©")
              exit(1)
          
          # Pr√©parer les donn√©es pour npoint.io
          payload = {
              "username": twitter_username,
              "followers_count": followers_count,
              "last_updated": datetime.utcnow().isoformat() + "Z",
              "timestamp": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC"),
              "source": "nitter",
              "instance": instance_used
          }
          
          print("üì§ Envoi des donn√©es √† npoint.io...")
          
          # Envoyer √† npoint.io
          try:
              headers = {
                  "Content-Type": "application/json"
              }
              
              response = requests.post(npoint_url, headers=headers, json=payload, timeout=10)
              
              if response.status_code in [200, 201]:
                  print("‚úÖ Donn√©es envoy√©es avec succ√®s √† npoint.io")
                  print("")
                  print("üìä Donn√©es envoy√©es:")
                  print(json.dumps(payload, indent=2, ensure_ascii=False))
              else:
                  print(f"‚ö†Ô∏è  Erreur lors de l'envoi: HTTP {response.status_code}")
                  print(f"Response: {response.text}")
                  
                  # Si POST √©choue, essayer PUT (mise √† jour)
                  print("")
                  print("üîÑ Tentative avec PUT...")
                  response = requests.put(npoint_url, headers=headers, json=payload, timeout=10)
                  
                  if response.status_code in [200, 201]:
                      print("‚úÖ Donn√©es mises √† jour avec succ√®s")
                      print("")
                      print("üìä Donn√©es envoy√©es:")
                      print(json.dumps(payload, indent=2, ensure_ascii=False))
                  else:
                      print(f"‚ùå √âchec de la mise √† jour: HTTP {response.status_code}")
                      exit(1)
                      
          except requests.exceptions.RequestException as e:
              print(f"‚ùå Erreur lors de la connexion √† npoint.io: {e}")
              exit(1)
          
          print("")
          print("‚ú® Op√©ration termin√©e avec succ√®s!")
          
          EOF

      - name: Create summary
        if: always()
        run: |
          echo "### üìä Mise √† jour des followers Twitter" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Compte surveill√©:** @UEFrance" >> $GITHUB_STEP_SUMMARY
          echo "**Date d'ex√©cution:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** npoint.io" >> $GITHUB_STEP_SUMMARY
