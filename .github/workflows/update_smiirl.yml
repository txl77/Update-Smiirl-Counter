name: Update Followers from Nitter

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch followers from Nitter and update npoint
        shell: bash
        run: |
          NITTER_URL="https://nitter.net/UEFrance"
          NPOINT_URL="https://api.npoint.io/5c1ef38596efbfb2bfe9"

          echo "Fetching followers from Nitter..."

          HTML=$(curl -s -H "User-Agent: Mozilla/5.0" "$NITTER_URL")

          FOLLOWERS=$(echo "$HTML" \
            | grep -oP '<li class="profile-stat">[\s\S]*?</li>' \
            | head -1 \
            | grep -oP '[0-9][0-9  ,]*' \
            | tr -cd '0-9')

          if [ -z "$FOLLOWERS" ]; then
            echo "Failed to fetch followers"
            echo "Debug output:"
            echo "$HTML" | head -c 800
            exit 1
          fi

          echo "Followers: $FOLLOWERS"

          curl -s -X POST "$NPOINT_URL" \
            -H "Content-Type: application/json" \
            -d "{\"number\": $FOLLOWERS}"

          echo "npoint updated successfully"
