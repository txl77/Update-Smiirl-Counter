name: Update Followers via Textise + Nitter

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch followers and update npoint
        shell: bash
        run: |
          NPOINT_URL="https://api.npoint.io/5c1ef38596efbfb2bfe9"
          TEXTISE_URL="http://textise.org/showtext.aspx?strURL=https://nitter.net/UEFrance"

          echo "Fetching followers via Textise..."

          HTML=$(curl -s "$TEXTISE_URL")

          FOLLOWERS=$(echo "$HTML" \
            | grep -i "Followers" -A1 \
            | grep -o '[0-9][0-9 ]*' \
            | head -1 \
            | tr -d ' ')

          if [ -z "$FOLLOWERS" ]; then
            echo "Failed to extract followers"
            echo "Debug output:"
            echo "$HTML" | head -c 800
            exit 1
          fi

          echo "Followers: $FOLLOWERS"

          curl -s -X POST "$NPOINT_URL" \
            -H "Content-Type: application/json" \
            -d "{\"number\": $FOLLOWERS}"

          echo "npoint updated successfully"
