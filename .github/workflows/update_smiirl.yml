name: Update Smiirl Counter with Nitter Followers

on:
  schedule:
    - cron: '0 10 * * *'  # Tous les jours à 10h (heure de Paris)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npm install playwright

      - name: Install browser
        run: npx playwright install chromium

      - name: Get followers from Nitter and update npoint
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');
          (async () => {
            try {
              const browser = await chromium.launch({ headless: true });
              const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              });
              const page = await context.newPage();

              console.log('Navigating to Nitter...');
              await page.goto('https://nitter.net/UEFrance', {
                waitUntil: 'domcontentloaded',
                timeout: 60000
              });

              // Attendre plus longtemps pour que la page charge complètement
              await page.waitForTimeout(10000);

              // Méthode 1: Essayer avec le sélecteur original
              let followers = null;
              try {
                await page.waitForSelector('.profile-stat-num', { timeout: 10000 });
                followers = await page.$eval('.profile-stat-num', el => el.innerText.replace(/,/g, '').trim());
              } catch (e) {
                console.log('Sélecteur .profile-stat-num non trouvé, essai d\'une autre méthode...');
              }

              // Méthode 2: Chercher dans tout le HTML
              if (!followers) {
                const content = await page.content();
                const match = content.match(/<span class="profile-stat-num">([\d,]+)<\/span>/);
                if (match) {
                  followers = match[1].replace(/,/g, '').trim();
                }
              }

              // Méthode 3: Chercher par texte
              if (!followers) {
                const elements = await page.$$eval('span', spans =>
                  spans.map(span => span.innerText)
                        .find(text => /^\d{1,3}(,\d{3})*$/.test(text))
                );
                if (elements) {
                  followers = elements.replace(/,/g, '').trim();
                }
              }

              if (followers) {
                console.log('Followers found:', followers);

                const response = await fetch('https://api.npoint.io/5c1ef38596efbfb2bfe9', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({number: parseInt(followers)})
                });

                if (!response.ok) throw new Error('Failed to update npoint');
                console.log('npoint updated successfully!');
              } else {
                console.error('Could not find follower count on Nitter');
                // Afficher une partie du HTML pour débogage
                const bodyHTML = await page.content();
                console.log('Page body sample (first 5000 chars):');
                console.log(bodyHTML.substring(0, 5000));
                process.exit(1);
              }

              await browser.close();
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          })();
          EOF
