name: Update Smiirl Counter

on:
  schedule:
    - cron: '0 10 * * *'  # Tous les jours à 10h (heure de Paris)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Get followers from Blastup and update npoint
        run: |
          # Installer les dépendances nécessaires
          sudo apt-get update
          sudo apt-get install -y curl jq

          # Récupérer le nombre d'abonnés depuis Blastup
          FOLLOWERS=$(curl -s "https://blastup.com/instagram-follower-count?uefrance" | \
                      grep -oP 'Followers.*?\K[0-9,]+' | \
                      tr -d ',' | \
                      head -1)

          if [ -z "$FOLLOWERS" ]; then
            echo "Erreur : Impossible de trouver le nombre d'abonnés sur Blastup"
            echo "Contenu de la page :"
            curl -s "https://blastup.com/instagram-follower-count?uefrance" | head -n 20
            exit 1
          fi

          echo "Nombre d'abonnés trouvé : $FOLLOWERS"

          # Mettre à jour npoint.io
          RESPONSE=$(curl -s -X POST "https://api.npoint.io/5c1ef38596efbfb2bfe9" \
                    -H "Content-Type: application/json" \
                    -d "{\"number\": $FOLLOWERS}")

          echo "npoint.io mis à jour avec succès !"
          echo "Réponse de l'API : $RESPONSE"
