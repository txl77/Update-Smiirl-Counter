name: Update Smiirl Counter

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npm install playwright

      - name: Install browser
        run: npx playwright install chromium

      - name: Get followers and update npoint
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');
          (async () => {
            try {
              const browser = await chromium.launch({ headless: true });
              const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                javaScriptEnabled: true,
              });
              const page = await context.newPage();

              console.log('Navigating to Instagram...');
              await page.goto('https://www.instagram.com/uefrance/', { waitUntil: 'domcontentloaded', timeout: 60000 });

              // Attendre que la page soit chargée
              await page.waitForTimeout(5000);

              // Extraire le nombre d'abonnés depuis les métadonnées ou le texte visible
              const followerText = await page.evaluate(() => {
                const metaTag = document.querySelector('meta[property="og:description"]');
                if (metaTag) {
                  const match = metaTag.content.match(/(\d+[\d,]*\d*) Followers/);
                  if (match) return match[1].replace(/,/g, '');
                }
                const header = document.querySelector('header');
                if (header) {
                  const text = header.innerText;
                  const match = text.match(/(\d+[\d,]*\d*) abonn[é|e]s/);
                  if (match) return match[1].replace(/,/g, '');
                }
                return null;
              });

              if (followerText) {
                const followers = parseInt(followerText);
                console.log('Followers found:', followers);

                const response = await fetch('https://api.npoint.io/5c1ef38596efbfb2bfe9', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({number: followers})
                });

                if (!response.ok) throw new Error('Failed to update npoint');
                console.log('npoint updated successfully!');
              } else {
                console.error('Could not find follower count in page content');
                process.exit(1);
              }

              await browser.close();
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          })();
          EOF
