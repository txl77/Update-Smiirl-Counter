name: Update Followers from Nitter

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch followers from Nitter and update npoint
        shell: bash
        run: |
          NPOINT_URL="https://api.npoint.io/5c1ef38596efbfb2bfe9"

          NITTER_INSTANCES=(
            "https://nitter.cz"
            "https://nitter.it"
            "https://nitter.privacydev.net"
            "https://nitter.poast.org"
          )

          HTML=""
          USED_INSTANCE=""

          for INSTANCE in "${NITTER_INSTANCES[@]}"; do
            echo "Trying $INSTANCE"
            HTML=$(curl -L -s \
              -H "User-Agent: Mozilla/5.0" \
              "$INSTANCE/UEFrance")

            if echo "$HTML" | grep -q "profile-stat"; then
              USED_INSTANCE="$INSTANCE"
              break
            fi
          done

          if [ -z "$USED_INSTANCE" ]; then
            echo "All Nitter instances failed"
            exit 1
          fi

          echo "Using $USED_INSTANCE"

          FOLLOWERS=$(echo "$HTML" \
            | sed 's/&nbsp;/ /g' \
            | tr -cd '0-9 \n' \
            | head -n 1 \
            | tr -d ' ')

          if [ -z "$FOLLOWERS" ]; then
            echo "Failed to extract followers"
            exit 1
          fi

          echo "Followers: $FOLLOWERS"

          curl -s -X POST "$NPOINT_URL" \
            -H "Content-Type: application/json" \
            -d "{\"number\": $FOLLOWERS}"

          echo "npoint updated successfully"
